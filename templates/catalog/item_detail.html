{% extends "theme/base.html" %}
{% load humanize %}

{% block title %}{{ item.code }}{% endblock %}
{% block page_title %}{{ item.code }} - {{ item.name }}{% endblock %}
{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'item_list' %}">Items</a></li>
<li class="breadcrumb-item active">{{ item.code }}</li>
{% endblock %}

{% block content %}
<div class="mb-3 d-flex justify-content-between">
  <a href="{% url 'item_list' %}" class="btn btn-secondary"><i class="fas fa-arrow-left mr-1"></i> Back</a>
  <div>
    <a href="#" data-modal-url="{% url 'item_edit' item.pk %}" class="btn btn-warning mr-1"><i class="fas fa-edit mr-1"></i> Edit</a>
    <a href="#" data-modal-url="{% url 'item_delete' item.pk %}" class="btn btn-danger"><i class="fas fa-trash mr-1"></i> Delete</a>
  </div>
</div>

<!-- Inventory KPI Cards -->
<div class="row">
  <div class="col-lg-3 col-md-6">
    <div class="small-box bg-info">
      <div class="inner"><h3>{{ totals.total_on_hand|floatformat:0 }}</h3><p>Total On Hand</p></div>
      <div class="icon"><i class="fas fa-cubes"></i></div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6">
    <div class="small-box bg-warning">
      <div class="inner"><h3>{{ totals.total_reserved|floatformat:0 }}</h3><p>Reserved</p></div>
      <div class="icon"><i class="fas fa-lock"></i></div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6">
    <div class="small-box bg-success">
      <div class="inner"><h3>{{ totals.total_available|floatformat:0 }}</h3><p>Available</p></div>
      <div class="icon"><i class="fas fa-check-circle"></i></div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6">
    <div class="small-box bg-primary">
      <div class="inner"><h3>{{ totals.total_value|floatformat:2|intcomma }}</h3><p>Inventory Value</p></div>
      <div class="icon"><i class="fas fa-coins"></i></div>
    </div>
  </div>
</div>

<div class="row">
  <!-- Item Details -->
  <div class="col-md-4">
    <div class="card card-outline card-primary">
      <div class="card-header"><h3 class="card-title"><i class="fas fa-info-circle mr-1"></i> Item Details</h3></div>
      <div class="card-body p-0">
        {% if item.image %}
        <div class="text-center p-3 border-bottom">
          <img src="{{ item.image.url }}" alt="{{ item.name }}" class="item-thumb" style="width:120px;height:120px;border-radius:10px;cursor:zoom-in;" loading="lazy">
        </div>
        {% endif %}
        <table class="table table-sm mb-0">
          <tr><th style="width:40%;">Code</th><td><strong>{{ item.code }}</strong></td></tr>
          <tr><th>Name</th><td>{{ item.name }}</td></tr>
          <tr><th>Type</th><td><span class="badge {% if item.item_type == 'RAW' %}bg-info{% elif item.item_type == 'FINISHED' %}bg-success{% else %}bg-secondary{% endif %}">{{ item.get_item_type_display }}</span></td></tr>
          <tr><th>Category</th><td>{{ item.category.name }}</td></tr>
          <tr><th>Unit</th><td>{{ item.default_unit.name }} ({{ item.default_unit.abbreviation }})</td></tr>
          <tr><th>Barcode</th><td>{{ item.barcode|default:"-" }}</td></tr>
          <tr><th>Cost Price</th><td>{{ item.cost_price|floatformat:2 }}</td></tr>
          <tr><th>Selling Price</th><td>{{ item.selling_price|floatformat:2 }}</td></tr>
          <tr><th>Min Stock</th><td>{{ item.minimum_stock|floatformat:0 }}</td></tr>
          <tr><th>Max Stock</th><td>{{ item.maximum_stock|floatformat:0 }}</td></tr>
          <tr><th>Reorder Point</th><td>{{ item.reorder_point|floatformat:0 }}</td></tr>
          {% if item.description %}<tr><th>Description</th><td>{{ item.description }}</td></tr>{% endif %}
        </table>
      </div>
    </div>
  </div>

  <!-- Stock by Warehouse + Location -->
  <div class="col-md-8">
    <!-- Warehouse Summary -->
    <div class="card card-outline card-success">
      <div class="card-header"><h3 class="card-title"><i class="fas fa-warehouse mr-1"></i> Stock by Warehouse</h3></div>
      <div class="card-body table-responsive p-0">
        <table class="table table-hover text-nowrap mb-0">
          <thead>
            <tr><th>Warehouse</th><th class="text-right">On Hand</th><th class="text-right">Reserved</th><th class="text-right">Available</th></tr>
          </thead>
          <tbody>
            {% for wh in warehouse_summary %}
            <tr>
              <td><i class="fas fa-warehouse mr-1 text-muted"></i> <strong>{{ wh.location__warehouse__code }}</strong> - {{ wh.location__warehouse__name }}</td>
              <td class="text-right">{{ wh.total_on_hand|floatformat:2 }}</td>
              <td class="text-right">{{ wh.total_reserved|floatformat:2 }}</td>
              <td class="text-right font-weight-bold {% if wh.total_on_hand > wh.total_reserved %}text-success{% elif wh.total_on_hand == wh.total_reserved %}text-warning{% else %}text-danger{% endif %}">{{ wh.total_on_hand|floatformat:2 }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="4" class="text-center text-muted py-3"><i class="fas fa-inbox mr-1"></i> No stock in any warehouse.</td></tr>
            {% endfor %}
          </tbody>
          {% if warehouse_summary %}
          <tfoot>
            <tr class="font-weight-bold bg-light">
              <td>TOTAL</td>
              <td class="text-right">{{ totals.total_on_hand|floatformat:2 }}</td>
              <td class="text-right">{{ totals.total_reserved|floatformat:2 }}</td>
              <td class="text-right">{{ totals.total_available|floatformat:2 }}</td>
            </tr>
          </tfoot>
          {% endif %}
        </table>
      </div>
    </div>

    <!-- Location Detail -->
    <div class="card card-outline card-info">
      <div class="card-header"><h3 class="card-title"><i class="fas fa-map-marker-alt mr-1"></i> Stock by Location</h3></div>
      <div class="card-body table-responsive p-0">
        <table class="table table-hover table-sm text-nowrap mb-0">
          <thead>
            <tr><th>Warehouse</th><th>Location</th><th class="text-right">On Hand</th><th class="text-right">Reserved</th><th class="text-right">Available</th></tr>
          </thead>
          <tbody>
            {% for bal in balances %}
            <tr>
              <td>{{ bal.location.warehouse.code }}</td>
              <td>{{ bal.location.code }}</td>
              <td class="text-right">{{ bal.qty_on_hand|floatformat:2 }}</td>
              <td class="text-right">{{ bal.qty_reserved|floatformat:2 }}</td>
              <td class="text-right">{{ bal.qty_available|floatformat:2 }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="5" class="text-center text-muted py-3">No stock balances.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Recent Stock Movements -->
<div class="card card-outline card-secondary">
  <div class="card-header"><h3 class="card-title"><i class="fas fa-exchange-alt mr-1"></i> Recent Stock Movements</h3></div>
  <div class="card-body table-responsive p-0">
    <table class="table table-hover text-nowrap mb-0">
      <thead>
        <tr><th>Date</th><th>Type</th><th class="text-right">Qty</th><th>Unit</th><th>From</th><th>To</th><th>Reference</th><th>By</th></tr>
      </thead>
      <tbody>
        {% for move in recent_moves %}
        <tr>
          <td>{{ move.posted_at|date:"M d, Y H:i" }}</td>
          <td>
            {% if move.move_type == 'RECEIVE' %}<span class="badge bg-success">{{ move.get_move_type_display }}</span>
            {% elif move.move_type == 'DELIVER' %}<span class="badge bg-primary">{{ move.get_move_type_display }}</span>
            {% elif move.move_type == 'TRANSFER' %}<span class="badge bg-info">{{ move.get_move_type_display }}</span>
            {% elif move.move_type == 'DAMAGE' %}<span class="badge bg-danger">{{ move.get_move_type_display }}</span>
            {% elif move.move_type == 'ADJUST' %}<span class="badge bg-warning">{{ move.get_move_type_display }}</span>
            {% elif move.move_type == 'POS_SALE' %}<span class="badge bg-dark">{{ move.get_move_type_display }}</span>
            {% elif move.move_type == 'RETURN_IN' %}<span class="badge" style="background:#6f42c1;color:#fff;">{{ move.get_move_type_display }}</span>
            {% else %}<span class="badge bg-secondary">{{ move.get_move_type_display }}</span>{% endif %}
          </td>
          <td class="text-right">{{ move.qty|floatformat:2 }}</td>
          <td>{{ move.unit.abbreviation }}</td>
          <td>{{ move.from_location.code|default:"-" }}</td>
          <td>{{ move.to_location.code|default:"-" }}</td>
          <td><small>{{ move.reference_number|default:"-" }}</small></td>
          <td>{{ move.created_by.get_full_name|default:move.created_by.username }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="8" class="text-center text-muted py-3"><i class="fas fa-inbox mr-1"></i> No movements recorded.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
