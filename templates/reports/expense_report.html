{% extends "theme/base.html" %}
{% load humanize %}
{% block title %}Expense Report{% endblock %}
{% block page_title %}Expense Report{% endblock %}
{% block breadcrumb %}<li class="breadcrumb-item"><a href="{% url 'reports_dashboard' %}">Reports</a></li><li class="breadcrumb-item active">Expenses</li>{% endblock %}

{% block content %}
<!-- Filters -->
<div class="card card-outline card-danger">
  <div class="card-body py-2">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-md-2"><label class="small">From</label><input type="date" name="date_from" class="form-control form-control-sm" value="{{ filters.date_from }}"></div>
      <div class="col-md-2"><label class="small">To</label><input type="date" name="date_to" class="form-control form-control-sm" value="{{ filters.date_to }}"></div>
      <div class="col-md-2">
        <label class="small">Category</label>
        <select name="category" class="form-control form-control-sm">
          <option value="">All</option>
          {% for cat in categories %}<option value="{{ cat.pk }}" {% if filters.category == cat.pk|stringformat:"d" %}selected{% endif %}>{{ cat.name }}</option>{% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="small">Group</label>
        <select name="group" class="form-control form-control-sm">
          <option value="daily" {% if group_by == "daily" %}selected{% endif %}>Daily</option>
          <option value="monthly" {% if group_by == "monthly" %}selected{% endif %}>Monthly</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="small">&nbsp;</label>
        <div class="d-flex flex-wrap">
          <button type="submit" class="btn btn-danger btn-sm mr-1 mb-1"><i class="fas fa-filter mr-1"></i> Apply</button>
          <button type="button" class="btn btn-sm btn-success mr-1 mb-1 wis-export-excel"><i class="fas fa-file-excel mr-1"></i> Excel</button>
          <button type="button" class="btn btn-sm btn-outline-danger mb-1 wis-export-pdf"><i class="fas fa-file-pdf mr-1"></i> PDF</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- KPI -->
<div class="row">
  <div class="col-lg-4 col-md-6">
    <div class="small-box bg-danger">
      <div class="inner"><h3>{{ total_expenses.total|floatformat:2|intcomma }}</h3><p>Total Expenses</p></div>
      <div class="icon"><i class="fas fa-receipt"></i></div>
    </div>
  </div>
  <div class="col-lg-4 col-md-6">
    <div class="small-box bg-secondary">
      <div class="inner"><h3>{{ total_expenses.count }}</h3><p>Transactions</p></div>
      <div class="icon"><i class="fas fa-list"></i></div>
    </div>
  </div>
</div>

<!-- Charts -->
<div class="row">
  <div class="col-md-8">
    <div class="card">
      <div class="card-header"><h3 class="card-title"><i class="fas fa-chart-bar mr-1"></i> Expense Trend ({{ group_by|title }})</h3></div>
      <div class="card-body"><canvas id="expChart" height="220"></canvas></div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card">
      <div class="card-header"><h3 class="card-title"><i class="fas fa-chart-pie mr-1"></i> By Category</h3></div>
      <div class="card-body"><canvas id="catChart" height="220"></canvas></div>
    </div>
  </div>
</div>

<!-- Tables -->
<div class="row">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header"><h3 class="card-title"><i class="fas fa-calendar mr-1"></i> {{ group_by|title }} Breakdown</h3></div>
      <div class="card-body table-responsive p-0">
        <table class="table table-hover table-sm text-nowrap">
          <thead><tr><th>Period</th><th class="text-right">Total</th><th class="text-right">Count</th></tr></thead>
          <tbody>
            {% for row in date_rows %}
            <tr>
              <td>{% if group_by == "daily" %}{{ row.period|date:"M d, Y" }}{% else %}{{ row.period|date:"F Y" }}{% endif %}</td>
              <td class="text-right">{{ row.total|floatformat:2|intcomma }}</td>
              <td class="text-right">{{ row.count }}</td>
            </tr>
            {% empty %}<tr><td colspan="3" class="text-center text-muted">No data</td></tr>{% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-header"><h3 class="card-title"><i class="fas fa-layer-group mr-1"></i> By Category</h3></div>
      <div class="card-body table-responsive p-0">
        <table class="table table-hover table-sm text-nowrap">
          <thead><tr><th>Category</th><th>Type</th><th class="text-right">Total</th><th class="text-right">Count</th></tr></thead>
          <tbody>
            {% for row in cat_rows %}
            <tr>
              <td><strong>{{ row.category__name }}</strong></td>
              <td>{% if row.category__is_cogs %}<span class="badge bg-warning">COGS</span>{% else %}<span class="badge bg-secondary">OPEX</span>{% endif %}</td>
              <td class="text-right">{{ row.total|floatformat:2|intcomma }}</td>
              <td class="text-right">{{ row.count }}</td>
            </tr>
            {% empty %}<tr><td colspan="4" class="text-center text-muted">No data</td></tr>{% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
new Chart(document.getElementById('expChart'), {
  type: 'bar', data: {
    labels: {{ chart_labels|safe }},
    datasets: [{ label: 'Expenses', data: {{ chart_data|safe }}, backgroundColor: 'rgba(220,53,69,.7)', borderRadius: 4 }]
  }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
});
const catColors = ['#dc3545','#fd7e14','#ffc107','#28a745','#17a2b8','#6f42c1','#007bff','#20c997'];
new Chart(document.getElementById('catChart'), {
  type: 'doughnut', data: {
    labels: {{ cat_labels|safe }},
    datasets: [{ data: {{ cat_data|safe }}, backgroundColor: catColors.slice(0, {{ cat_labels|safe }}.length) }]
  }, options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } } }
});
</script>
{% endblock %}
